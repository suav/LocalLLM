version: '3.8'

services:
  stable-diffusion:
    image: stable-diffusion-ready:latest
    container_name: sd-webui-fast
    ports:
      - "7860:7860"
    volumes:
      - ./sd-data/models:/app/models
      - ./sd-data/outputs:/app/outputs  
      - ./real_sd_server.py:/app/server.py
    working_dir: /app
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - HF_DATASETS_OFFLINE=0
      - TRANSFORMERS_OFFLINE=0
      - HF_HUB_OFFLINE=0
      - TORCH_HOME=/app/models/torch
    # GPU support - NVIDIA Container Toolkit is now installed!
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    # Increase shared memory for large model loading
    shm_size: '2gb'
    # Increase ulimits for model loading
    ulimits:
      memlock: -1
      stack: 67108864
    # Fast startup - no dependency installation needed!
    command: >
      bash -c '
      echo "ðŸš€ Fast startup with pre-loaded Stable Diffusion image!" &&
      echo "âš¡ All dependencies already installed - starting server directly..." &&
      python server.py
      '
    restart: unless-stopped