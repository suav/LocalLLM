version: '3.8'

services:
  stable-diffusion:
    image: python:3.10-slim
    container_name: sd-webui
    ports:
      - "7860:7860"
    volumes:
      - ./sd-data/models:/app/models
      - ./sd-data/outputs:/app/outputs  
      - ./real_sd_server.py:/app/server.py
    working_dir: /app
    dns:
      - 8.8.8.8
      - 8.8.4.4
    environment:
      - HF_DATASETS_OFFLINE=0
      - TRANSFORMERS_OFFLINE=0
      - HF_HUB_OFFLINE=0
      - TORCH_HOME=/app/models/torch
    command: >
      bash -c "
      echo 'Installing dependencies...' &&
      pip install fastapi uvicorn pillow pydantic &&
      echo 'Installing PyTorch CPU version...' &&
      pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu &&
      echo 'Installing diffusers...' &&
      pip install diffusers transformers accelerate &&
      echo 'Starting server...' &&
      python server.py
      "
    restart: unless-stopped